pipeline {
    agent any

    environment {
        // Sonar
        SONAR_AUTH = credentials('sonar-token')
        SONAR_URL = credentials('sonar-url')

        // Artifactory
        ARTIFACTORY_URL = credentials('artifactory-url')
        ARTIFACTORY_CREDS = credentials('artifactory-creds')

        // DockerHub
        DOCKERHUB_CREDS = credentials('docker')

        // GitHub (IMPORTANT)
        GIT_CREDS = credentials('github-creds')

        IMAGE_NAME = "aayush-devsecops"
        DEPLOY_REPO = "https://github.com/Aayushgit18/Devsecops-aayush.git"
    }

    stages {

        stage('Pull Code') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/Aayushgit18/Devsecops-aayush.git'
            }
        }

        stage('Maven Build') {
            steps {
                sh '''
                    cd java-maven-sonar-argocd-helm-k8s/spring-boot-app
                    mvn clean package -DskipTests
                '''
            }
        }

        stage('SonarQube Scan') {
            steps {
                sh '''
                    cd java-maven-sonar-argocd-helm-k8s/spring-boot-app
                    mvn sonar:sonar \
                      -Dsonar.projectKey=devsecops-aayush \
                      -Dsonar.host.url=${SONAR_URL} \
                      -Dsonar.token=${SONAR_AUTH}
                '''
            }
        }

        stage('Trivy FS Scan') {
            steps {
                sh '''
                    trivy fs java-maven-sonar-argocd-helm-k8s --exit-code 0 --format table
                '''
            }
        }

        stage('Upload JAR to JFrog Maven Repo') {
            steps {
                sh '''
                    JAR_FILE=$(find java-maven-sonar-argocd-helm-k8s -name "*.jar" | head -1)
                    VERSIONED_JAR=spring-boot-web-b${BUILD_NUMBER}.jar

                    cp $JAR_FILE $VERSIONED_JAR

                    curl -u ${ARTIFACTORY_CREDS_USR}:${ARTIFACTORY_CREDS_PSW} \
                     -T $VERSIONED_JAR \
                     ${ARTIFACTORY_URL}/maven-repo/
                '''
            }
        }

        stage('Docker Build') {
            steps {
                sh '''
                    cd java-maven-sonar-argocd-helm-k8s/spring-boot-app
                    docker build -t ${DOCKERHUB_CREDS_USR}/${IMAGE_NAME}:b${BUILD_NUMBER} .
                '''
            }
        }

        stage('Trivy Docker Image Scan (HTML Only)') {
            steps {
                sh '''
                    trivy image ${DOCKERHUB_CREDS_USR}/${IMAGE_NAME}:b${BUILD_NUMBER} \
                    --severity HIGH,CRITICAL \
                    --format template \
                    --template @/usr/local/share/trivy/templates/html.tpl \
                    --output trivy-image-report.html
                '''
            }
        }

        stage('DockerHub Push') {
            steps {
                sh '''
                    echo ${DOCKERHUB_CREDS_PSW} | docker login -u ${DOCKERHUB_CREDS_USR} --password-stdin
                    docker push ${DOCKERHUB_CREDS_USR}/${IMAGE_NAME}:b${BUILD_NUMBER}
                '''
            }
        }

        stage('Update ArgoCD Deployment Repo') {
            steps {
                sh '''
                    rm -rf deploy-repo

                    git clone https://${GIT_CREDS_USR}:${GIT_CREDS_PSW}@github.com/Aayushgit18/Devsecops-aayush.git deploy-repo

                    cd deploy-repo/Devsecops-aayush-deploy/base

                    sed -i "s|image: .*|image: docker.io/${DOCKERHUB_CREDS_USR}/${IMAGE_NAME}:b${BUILD_NUMBER}|" deployment.yaml

                    git config --global user.email "jenkins@devops.com"
                    git config --global user.name "Jenkins"

                    git add .
                    git commit -m "Updated image to b${BUILD_NUMBER}"
                    git push
                '''
            }
        }
    }

    post {
        always {
            echo "Pipeline completed with full DevSecOps + GitOps deployment."
        }
    }
}
